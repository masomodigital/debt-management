<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masomo Debtor Dashboard</title>
  <style>
    /* Replace your current html, body CSS with this */
html, body { 
  margin: 0; 
  font-family: Arial, sans-serif; 
  background: #f5f5f5; 
  min-height: 100%; 
  display: block;      /* allows natural scrolling */
}

#container { 
  width: 95%; 
  max-width: 980px; 
  padding: 12px; 
  box-sizing: border-box; 
  margin: 0 auto;      /* horizontal centering */
}

    .card { background:#fff; padding:14px; border-radius:10px; box-shadow:0 1px 6px rgba(0,0,0,0.08); margin-bottom:12px; }
    h2 { margin:0 0 8px 0; }
    label { display:block; margin-top:8px; }
    input[type="text"], input[type="date"], input[type="number"], input[type="password"]{ width:100%; padding:8px; box-sizing:border-box; }
    button { padding:8px 12px; margin-top:10px; border:none; border-radius:6px; cursor:pointer; background:#1976d2; color:#fff; }
    .danger { background:#e53935; color:#fff; font-weight:bold; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f4f4f4; }
    .muted { color:#666; font-size:13px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width:150px; }
    .summary { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .summary .card { flex:1; text-align:center; }
    .wait { color:#2e7d32; font-weight:bold; }
    .small { font-size:13px; color:#444; }
    .actions button { margin-right:6px; }

    /* MOBILE FRIENDLY TABLE */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    table { min-width: 700px; }
  </style>
</head>
<body>
  <div id="container">
    <!-- LOGIN -->
    <div id="loginView" class="card">
      <div style="text-align: center; margin-bottom: 20px;">
        <img src="https://i.imgur.com/0mlO4gB.png" alt="Logo" style="max-width: 250px; width: 100%; height: auto;">
      </div>

      <h2>DEBTOR MANAGEMENT SYSTEM</h2>

      <p style="color: green; font-weight: bold; font-size: 1.1em; text-align: center; margin-top: 15px;">
        Masomo SMS App will automatically remind your debtors to pay you 5 days BEFORE debt payment DEADLINE, and continue to remind them DAILY if they fail to pay - UNTIL THEY PAY! Simply input the debt details and let the app work for you!
      </p>

      <div class="muted">Login with your User ID and Password</div>
      <label>National ID<input id="nid" type="text" /></label>
      <label>Password<input id="pwd" type="password" /></label>
      <button id="loginBtn">Login</button>
      <div id="loginMsg" class="muted"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardView" style="display:none;">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
          <h2 id="welcome">Welcome</h2>
          <div id="userInfo" class="muted small"></div>
        </div>
        <div>
          <button id="logoutBtn" style="background:#e53935">Logout</button>
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="summary">
        <div class="card"><div class="muted">TOTAL DEBTORS</div><h2 id="totalDebtors">0</h2></div>
        <div class="card"><div class="muted">TOTAL UNPAID (Sh.)</div><h2 id="totalUnpaid">0</h2></div>
        <div class="card"><div class="muted">SMS CREDITS BALANCE</div><h2 id="userCredits">0</h2></div>
      </div>

      <!-- ADD / EDIT -->
      <div class="card">
        <h3 id="formTitle">ADD DEBTOR</h3>
        <div class="row">
          <div class="col">
            <label>Debtor Name<input id="dName" type="text" /></label>
            <label>Phone<input id="dPhone" type="text" /></label>
          </div>
          <div class="col">
            <label>Amount (Sh.)<input id="dAmount" type="number" /></label>
            <label>Repayment Date<input id="dRepayment" type="date" /></label>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
          <button id="addDebtorBtn">ADD DEBTOR</button>
          <button id="cancelEditBtn" style="background:#9e9e9e; display:none;">CANCEL</button>
          <div id="addMsg" class="muted"></div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="card">
        <h3>YOUR DEBTORS</h3>
        <div class="table-wrapper">
          <table id="debtorsTable">
            <thead>
              <tr>
                <th>Name</th><th>Phone</th><th>Amount</th><th>Repayment</th><th>Status</th><th>Last Reminder</th><th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="tableMsg" class="muted"></div>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG: point to your Worker (proxy to GAS) ===== */
const API_URL = "https://shiny-cloud-acd2.ev-dmaundu.workers.dev/";

/* Generic POST helper to worker */
async function callAPI(action, payload = {}) {
  try {
    const body = JSON.stringify({ action, ...payload });
    const resp = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body
    });
    const text = await resp.text();
    try { return JSON.parse(text); } catch (e) { return text; }
  } catch (e) {
    console.error("callAPI error:", e);
    return { success: false, message: e.message || "Network error" };
  }
}

/* ===== State ===== */
let currentUser = null;
let editingRow = null;

/* ===== UI bindings ===== */
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginMsg = document.getElementById("loginMsg");
const tableMsg = document.getElementById("tableMsg");
const addMsg = document.getElementById("addMsg");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const addDebtorBtn = document.getElementById("addDebtorBtn");

loginBtn.addEventListener("click", async () => {
  const nid = document.getElementById("nid").value.trim();
  const pwd = document.getElementById("pwd").value.trim();
  if (!nid || !pwd) { loginMsg.textContent = "Enter ID and password"; return; }
  loginMsg.innerHTML = '<span class="wait">Wait please...</span>';
  const res = await callAPI("loginUser", { nid, pwd });
  if (res && res.success) {
    currentUser = res.user;
    document.getElementById("loginView").style.display = "none";
    document.getElementById("dashboardView").style.display = "block";
    document.getElementById("welcome").textContent = `Hello, ${currentUser.name}`;
    document.getElementById("userInfo").textContent = `Phone: ${currentUser.phone} â€¢ National ID: ${currentUser.userID}`;
    document.getElementById("userCredits").textContent = currentUser.credits ?? 0;
    loginMsg.textContent = "";
    refreshDashboard();
  } else {
    loginMsg.textContent = res && res.message ? res.message : "Login failed";
  }
});

logoutBtn.addEventListener("click", () => {
  currentUser = null;
  editingRow = null;
  document.getElementById("loginView").style.display = "block";
  document.getElementById("dashboardView").style.display = "none";
  document.getElementById("nid").value = "";
  document.getElementById("pwd").value = "";
  document.getElementById("addMsg").textContent = "";
  document.getElementById("addDebtorBtn").textContent = "ADD DEBTOR";
  document.getElementById("formTitle").textContent = "ADD DEBTOR";
  cancelEditBtn.style.display = "none";
});

/* Refresh summary + debtors */
async function refreshDashboard() {
  if (!currentUser) return;
  tableMsg.innerHTML = '<span class="wait">Wait please...</span>';
  const rows = await callAPI("getDebtorsForUser", { userID: currentUser.userID });
  const summary = await callAPI("getSummaryForUser", { userID: currentUser.userID });
  renderSummary(summary || {});
  renderDebtors(Array.isArray(rows) ? rows : (rows.debtors || rows));
  tableMsg.textContent = "";
}

function renderSummary(s) {
  document.getElementById("totalDebtors").textContent = s.totalDebtors ?? 0;
  document.getElementById("totalUnpaid").textContent = s.totalUnpaid ?? 0;
}

function renderDebtors(rows) {
  const tbody = document.querySelector("#debtorsTable tbody");
  tbody.innerHTML = "";
  if (!rows || rows.length === 0) {
    tableMsg.textContent = "No debtors yet.";
    return;
  }
  tableMsg.textContent = "";
  rows.forEach(r => {
    const name = r.DebtorName ?? "";
    const phone = r.Phone != null ? String(r.Phone) : "";
    const amount = r.Amount != null ? String(r.Amount) : "";
    const repayment = formatDate(r.RepaymentDate);
    const status = r.Status ?? "";
    const lastReminder = formatDate(r.LastReminderDate);
    const sheetRow = r.sheetRow ?? "";

    const tr = document.createElement("tr");
    tr.className = String(status).toLowerCase() === "unpaid" ? "danger" : "";
    tr.innerHTML = `
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(phone)}</td>
      <td>${escapeHtml(amount)}</td>
      <td>${escapeHtml(repayment)}</td>
      <td>${escapeHtml(status)}</td>
      <td>${escapeHtml(lastReminder)}</td>
      <td class="actions">
        ${String(status).toLowerCase() === "unpaid" ? `<button data-row="${sheetRow}" class="markPaidBtn">Mark Paid</button>` : ""}
        <button data-row="${sheetRow}" class="editDebtorBtn">Edit</button>
        <button data-row="${sheetRow}" class="deleteDebtorBtn" style="background:#000; color:#fff;">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  Array.from(document.getElementsByClassName("markPaidBtn")).forEach(b => {
    b.addEventListener("click", async function() {
      const sheetRow = Number(this.getAttribute("data-row"));
      this.disabled = true;
      tableMsg.innerHTML = '<span class="wait">Wait please...</span>';
      const res = await callAPI("markDebtorPaid", { sheetRow });
      if (res && res.success) refreshDashboard();
      else { tableMsg.textContent = res && res.message ? res.message : "Failed to mark paid"; }
    });
  });

  Array.from(document.getElementsByClassName("editDebtorBtn")).forEach(b => {
    b.addEventListener("click", function() {
      const sheetRow = Number(this.getAttribute("data-row"));
      const tr = this.closest("tr");
      const tds = tr.querySelectorAll("td");
      document.getElementById("dName").value = tds[0].textContent || "";
      document.getElementById("dPhone").value = tds[1].textContent || "";
      document.getElementById("dAmount").value = tds[2].textContent || "";
      const parts = tds[3].textContent.split("/");
      document.getElementById("dRepayment").value = (parts.length === 3) ? `${parts[2]}-${parts[1]}-${parts[0]}` : "";
      editingRow = sheetRow;
      document.getElementById("addDebtorBtn").textContent = "SAVE CHANGES";
      document.getElementById("formTitle").textContent = "EDIT DEBTOR";
      cancelEditBtn.style.display = "inline-block";
      addMsg.textContent = "";
    });
  });

  Array.from(document.getElementsByClassName("deleteDebtorBtn")).forEach(b => {
    b.addEventListener("click", async function() {
      const sheetRow = Number(this.getAttribute("data-row"));
      if (!confirm("Are you sure you want to delete this debtor?")) return;
      tableMsg.innerHTML = '<span class="wait">Deleting...</span>';
      const res = await callAPI("deleteDebtor", { sheetRow });
      if (res && res.success) refreshDashboard();
      else tableMsg.textContent = res && res.message ? res.message : "Delete failed";
    });
  });
}

/* Add / Update debtor */
addDebtorBtn.addEventListener("click", async () => {
  const name = document.getElementById("dName").value.trim();
  const phone = document.getElementById("dPhone").value.trim();
  const amount = document.getElementById("dAmount").value.trim();
  const repayment = document.getElementById("dRepayment").value;

  if (!name || !phone || !amount || !repayment) {
    addMsg.textContent = "Please fill all fields.";
    return;
  }

  const debtorObj = {
    DebtorName: name,
    Phone: phone,
    Amount: Number(amount),
    DebtDate: new Date().toISOString().slice(0,10),
    RepaymentDate: new Date(repayment).toISOString()
  };

  addMsg.innerHTML = '<span class="wait">Wait please...</span>';

  if (editingRow) {
    const res = await callAPI("updateDebtor", { sheetRow: Number(editingRow), debtorObj });
    if (res && res.success) {
      addMsg.textContent = "Debtor updated.";
      editingRow = null;
      document.getElementById("addDebtorBtn").textContent = "ADD DEBTOR";
      document.getElementById("formTitle").textContent = "ADD DEBTOR";
      cancelEditBtn.style.display = "none";
      clearForm();
      refreshDashboard();
    } else {
      addMsg.textContent = res && res.message ? res.message : "Failed to update debtor.";
    }
  } else {
    const res = await callAPI("addDebtor", { userID: currentUser.userID, debtorObj });
    if (res && res.success) {
      addMsg.textContent = "Debtor added.";
      clearForm();
      refreshDashboard();
    } else {
      addMsg.textContent = res && res.message ? res.message : "Failed to add debtor.";
    }
  }
});

cancelEditBtn.addEventListener("click", () => {
  editingRow = null;
  document.getElementById("addDebtorBtn").textContent = "ADD DEBTOR";
  document.getElementById("formTitle").textContent = "ADD DEBTOR";
  cancelEditBtn.style.display = "none";
  clearForm();
  addMsg.textContent = "";
});

function clearForm() {
  document.getElementById("dName").value = "";
  document.getElementById("dPhone").value = "";
  document.getElementById("dAmount").value = "";
  document.getElementById("dRepayment").value = "";
}

function formatDate(d) {
  if (!d) return "";
  try {
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return "";
    const day = ("0" + dt.getDate()).slice(-2);
    const month = ("0" + (dt.getMonth() + 1)).slice(-2);
    const year = dt.getFullYear();
    return `${day}/${month}/${year}`;
  } catch (e) {
    return "";
  }
}

function escapeHtml(str) {
  if (!str) return "";
  return String(str).replace(/[&<>"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
  });
}

document.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && (document.activeElement.tagName === "INPUT")) {
    e.preventDefault();
  }
});
</script>
</body>
</html>
