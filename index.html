<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Masomo Debtor Dashboard</title>
<style>
  html, body { height:100%; margin:0; font-family: Arial, sans-serif; background:#f5f5f5; display:flex; justify-content:center; align-items:center; }
  #container { width:95%; max-width:900px; }
  .card { background:#fff; padding:20px; border-radius:8px; box-shadow:0 1px 5px rgba(0,0,0,0.1); margin-bottom:15px; }
  h2,h3 { margin:0 0 10px 0; }
  label {display:block; margin-top:10px; font-weight:bold;}
  input[type="text"], input[type="number"], input[type="password"], input[type="date"] { width:100%; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; font-size:16px; }
  button { padding:10px 16px; margin-top:12px; border:none; border-radius:6px; cursor:pointer; background:#1976d2; color:#fff; font-size:16px; }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:left; }
  .muted { color:#666; font-size:14px; }
  .row { display:flex; gap:15px; flex-wrap: wrap; }
  .col { flex:1; min-width:150px; }
  .summary { display:flex; gap:15px; flex-wrap:wrap; }
  .summary .card { flex:1; text-align:center; }
  .danger { background:#fdd; color:#900; font-weight:bold; }
  .success { background:#dff0d8; color:#2e7d32; font-weight:bold; }
  .wait { color:#2e7d32; font-weight:bold; }
  .summary .muted { font-weight:bold; color:green; }
  #spinner { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.6); z-index:9999; justify-content:center; align-items:center; }
  #spinner div { border:6px solid #ccc; border-top:6px solid #1976d2; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
  @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>
<body>
<div id="spinner"><div></div></div>
<div id="container">

  <div id="loginView" class="card">
    <h2>DEBTOR MANAGEMENT SYSTEM</h2>
    <div class="muted">Login with your User ID and Password</div>
    <label>National ID<input id="nid" type="text" /></label>
    <label>Password<input id="pwd" type="password" /></label>
    <button id="loginBtn">Login</button>
    <div id="loginMsg" class="muted"></div>
  </div>

  <div id="dashboardView" style="display:none;">
    <div class="card">
      <div style="display:flex; justify-content:space-between; flex-wrap:wrap;">
        <div>
          <h2 id="welcome">Welcome</h2>
          <div class="muted" id="userInfo"></div>
        </div>
        <div>
          <button id="logoutBtn" style="background:#e53935">Logout</button>
        </div>
      </div>
    </div>

    <div class="summary">
      <div class="card">
        <div class="muted">TOTAL DEBTORS</div>
        <h2 id="totalDebtors">0</h2>
      </div>
      <div class="card">
        <div class="muted">TOTAL UNPAID (Sh.)</div>
        <h2 id="totalUnpaid">0</h2>
      </div>
      <div class="card">
        <div class="muted">SMS CREDITS BALANCE</div>
        <h2 id="userCredits">0</h2>
      </div>
    </div>

    <div class="card">
      <h3>ADD DEBTORS</h3>
      <div class="row">
        <div class="col">
          <label>Debtor Name<input id="dName" type="text" /></label>
          <label>Phone<input id="dPhone" type="text" /></label>
        </div>
        <div class="col">
          <label>Amount (Sh.)<input id="dAmount" type="number" /></label>
          <label>Repayment Date<input id="dRepayment" type="date" /></label>
        </div>
      </div>
      <button id="addDebtorBtn">ADD DEBTOR</button>
      <div id="addMsg" class="muted"></div>
    </div>

    <div class="card">
      <h3>YOUR DEBTORS</h3>
      <table id="debtorsTable">
        <thead>
          <tr><th>Name</th><th>Phone</th><th>Amount</th><th>Repayment</th><th>Status</th><th>Last Reminder</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="tableMsg" class="muted"></div>
    </div>

  </div>
</div>

<script>
const WORKER_URL = "https://shiny-cloud-acd2.ev-dmaundu.workers.dev/";

function showSpinner(show) { document.getElementById('spinner').style.display = show ? 'flex' : 'none'; }

async function callAPI(action, payload={}) {
  try {
    showSpinner(true);
    const res = await fetch(WORKER_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ action, ...payload })
    });
    return await res.json();
  } catch(err) {
    console.error(err);
    return { success:false, message:"Network error" };
  } finally {
    showSpinner(false);
  }
}

let currentUser = null;
let editingRow = null;

document.getElementById('loginBtn').addEventListener('click', async () => {
  const nid = document.getElementById('nid').value.trim();
  const pwd = document.getElementById('pwd').value.trim();
  if(!nid || !pwd){ document.getElementById('loginMsg').textContent="Please fill all fields."; return; }
  document.getElementById('loginMsg').textContent='';
  const result = await callAPI("loginUser", {nid, pwd});
  onLogin(result);
});

function onLogin(result){
  if(result && result.success){
    currentUser=result.user;
    document.getElementById('loginView').style.display='none';
    document.getElementById('dashboardView').style.display='block';
    document.getElementById('welcome').textContent=`Hello, ${currentUser.name}`;
    document.getElementById('userInfo').textContent=`Phone: ${currentUser.phone} â€¢ National ID: ${currentUser.userID}`;
    document.getElementById('userCredits').textContent=currentUser.credits;
    refreshDashboard();
  } else document.getElementById('loginMsg').textContent=result.message || "Login failed";
}

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  currentUser=null;
  editingRow=null;
  document.getElementById('loginView').style.display='block';
  document.getElementById('dashboardView').style.display='none';
  document.getElementById('nid').value='';
  document.getElementById('pwd').value='';
  document.getElementById('loginMsg').textContent='';
  document.getElementById('addDebtorBtn').textContent="ADD DEBTOR";
});

async function refreshDashboard(){
  if(!currentUser) return;
  const rows=await callAPI("getDebtorsForUser",{userID:currentUser.userID});
  renderDebtors(rows);
  const summary=await callAPI("getSummaryForUser",{userID:currentUser.userID});
  renderSummary(summary);
}

function renderSummary(s){
  document.getElementById('totalDebtors').textContent=s.totalDebtors||0;
  document.getElementById('totalUnpaid').textContent=s.totalUnpaid||0;
  document.getElementById('userCredits').textContent=currentUser.credits||0;
}

function renderDebtors(rows){
  const tbody=document.querySelector('#debtorsTable tbody');
  tbody.innerHTML="";
  if(!rows || rows.length===0){ document.getElementById('tableMsg').textContent="No debtors yet."; return; }
  document.getElementById('tableMsg').textContent="";
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.className=(r.Status && r.Status.toLowerCase()==='unpaid')?'danger':'';
    tr.innerHTML=`
      <td>${escapeHtml(r.DebtorName||"")}</td>
      <td>${escapeHtml(r.Phone||"")}</td>
      <td>${escapeHtml(r.Amount||"")}</td>
      <td>${escapeHtml(formatDate(r.RepaymentDate))}</td>
      <td>${escapeHtml(r.Status||"")}</td>
      <td>${escapeHtml(formatDate(r.LastReminderDate))}</td>
      <td>
        ${r.Status && r.Status.toLowerCase()==='unpaid'?`<button data-row="${r.sheetRow}" class="markPaidBtn">Mark Paid</button>`:""}
        <button data-row="${r.sheetRow}" class="editDebtorBtn">Edit</button>
        <button data-row="${r.sheetRow}" class="deleteDebtorBtn" style="background:#000;color:#fff;">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.markPaidBtn').forEach(b=>b.addEventListener('click', async function(){
    this.disabled=true;
    await callAPI("markDebtorPaid",{sheetRow:this.getAttribute('data-row')});
    refreshDashboard();
  }));

  document.querySelectorAll('.editDebtorBtn').forEach(b=>b.addEventListener('click', function(){
    const tr=this.closest('tr');
    const tds=tr.querySelectorAll('td');
    document.getElementById('dName').value=tds[0].textContent;
    document.getElementById('dPhone').value=tds[1].textContent;
    document.getElementById('dAmount').value=tds[2].textContent;
    editingRow=this.getAttribute('data-row');
    document.getElementById('addDebtorBtn').textContent="SAVE CHANGES";
  }));

  document.querySelectorAll('.deleteDebtorBtn').forEach(b=>b.addEventListener('click', async function(){
    if(!confirm('Are you sure you want to delete this debtor?')) return;
    await callAPI("deleteDebtor",{sheetRow:this.getAttribute('data-row')});
    refreshDashboard();
  }));
}

document.getElementById('addDebtorBtn').addEventListener('click', async ()=>{
  const name=document.getElementById('dName').value.trim();
  const phone=document.getElementById('dPhone').value.trim();
  const amount=document.getElementById('dAmount').value.trim();
  const repayment=document.getElementById('dRepayment').value;
  if(!name||!phone||!amount||!repayment){ document.getElementById('addMsg').textContent="Please fill all fields."; return; }
  const obj={DebtorName:name,Phone:phone,Amount:amount,DebtDate:new Date().toISOString().slice(0,10),RepaymentDate:repayment};
  if(editingRow){
    await callAPI("updateDebtor",{sheetRow:editingRow,debtorObj:obj});
    editingRow=null;
    document.getElementById('addDebtorBtn').textContent="ADD DEBTOR";
  } else await callAPI("addDebtor",{userID:currentUser.userID,debtorObj:obj});
  resetForm();
  refreshDashboard();
});

function resetForm(){
  document.getElementById('dName').value='';
  document.getElementById('dPhone').value='';
  document.getElementById('dAmount').value='';
  document.getElementById('dRepayment').value='';
}

function formatDate(d){
  if(!d) return "";
  const dt=new Date(d);
  if(isNaN(dt)) return "";
  return `${("0"+dt.getDate()).slice(-2)}/${("0"+(dt.getMonth()+1)).slice(-2)}/${dt.getFullYear()}`;
}

function escapeHtml(str){ return String(str||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
